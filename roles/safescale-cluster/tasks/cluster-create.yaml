---
- name: Loading clusters list
  shell: "{{ safescale_path }} cluster list | jq"
  register: cluster_list

- name: Creating cluster with safescale
  block:
    - name: Create safescale cluster
      shell: |
        {{ safescale_path }} \
        cluster create \
        --complexity {{ cluster.complexity }} \
        --flavor BOH \
        {% if cluster.cidr is defined %}--cidr {{ cluster.cidr }}{% endif %} \
        --disable remotedesktop \
        --disable reverseproxy \
        --os {{ cluster.os }} \
        --master-sizing cluster.node_groups.kube_control_plane.sizing \
        --node-sizing cluster.node_groups.infra.sizing \
        --gw-sizing cluster.node_groups.gateway.sizing \
        {{ cluster.name }}

    - name: Tag created nodes
      shell: |
        for i in  $(./safescale cluster inspect rs-dev | jq -c -r '.result.nodes.masters[].name'); do \
          ./safescale host tag $i kube_control_plane; done \
        && for i in  $(./safescale cluster inspect rs-dev | jq -c -r '.result.nodes.nodes[].name'); do \
          ./safescale host tag $i infra; done \
        && ./safescale host tag gw-{{ cluster.name }} gateway \ 
        {% if cluster.complexity == 'small' %} && ./safescale host tag gw2-{{ cluster.name }} gateway {% endif %}

    - name: Expand cluster to desired size
      include_tasks: expand-cluster.yaml
      loop: "{{ cluster.node_groups | dict2items }}"
      loop_control:
        loop_var: expand_node_group
      when: node_group not in ['kube_control_plane', 'gateway'] 

  when: not cluster.name in cluster_list.stdout
