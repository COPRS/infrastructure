- name: tmp file for values
  tempfile:
    state: file
    suffix: values
  register: temp_values
  when: 
    - values.stat.exists

- name: copy values to remote host
  copy:
    src: "{{ values.stat.path }}"
    dest: "{{ temp_values.path }}"
  when: 
    - values.stat.exists

- name: Create manifest from Helm chart with values
  shell:
    cmd: >
      helm template {{ app_name }} {{ app.chart_ref }}
      {% if app.chart_version is defined %}--version {{ app.chart_version }}{% endif %}
      {% if app.namespace is defined %}--namespace {{ app.namespace}}{% endif %}
      {% if temp_values.path is defined %}--values {{ temp_values.path }}{% endif %}
  register: manifest

- name: Send manifest to controller
  copy:
    content: "{{ manifest.stdout }}"
    dest: "{{ values.stat.path | dirname }}/manifest.yaml"
  delegate_to: localhost
  when: manifest is defined
