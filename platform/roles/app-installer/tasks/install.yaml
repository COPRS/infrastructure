- name: Install app
  block:
    - name: Gather facts
      local_action:
        module: import_tasks
        file: gather_facts.yaml

    - name: "{{ app_name }} |Â Deploy with kustomize"
      include_tasks: kustomize.yaml
      when: kustomization.stat.exists
      
    - name: "{{ app_name }} | Deploy with Helm"
      include_tasks: install_helm_chart.yaml
      when:
        - not kustomization.stat.exists
        - values.stat.exists
  always:
    - name: "{{ app_name }} | remove tmp dir"
      file:
        path: "{{ kustomize_dir.path }}"
        state: absent
      when: kustomize_dir.path is defined

    - name: "{{ app_name }} | remove tmp file"
      file:
        path: "{{ temp_values.path }}"
        state: absent
      when: temp_values.path is defined