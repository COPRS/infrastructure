- name: Check whether kustomization exists
  stat:
    path: "{{ app_dir }}/kustomization.yaml"
  register: kustomization

- name: Check whether values exists
  stat:
    path: "{{ app_dir }}/values.yaml"
  register: values

- name: Check whether additional_resources directory exists
  stat:
    path: "{{ app_dir }}/additional_resources"
  register: additional_resources

- name: Fail when neither file is present
  fail:
    msg: "No kustomization.yaml or values.yaml file found in {{ app_dir }}"
  when: 
    - not kustomization.stat.exists
    - not values.stat.exists

- name: Check whether config.yaml file exists
  stat:
    path: "{{ app_dir }}/config.yaml"
  register: config_file

- name: Config file does not exist
  fail:
    msg: "No config.yaml file present in {{ app_dir }}"
  when: 
    - not config_file.stat.exists
    - values.stat.exists

- name: Get app config
  include_vars:
    file: "{{ app_dir }}/config.yaml"
    name: app
  when: config_file.stat.exists

- name: 'Fallback for namespace: read kustomization.yaml'
  include_vars:
    file: "{{ app_dir }}/kustomization.yaml"
  when:
    - kustomization.stat.exists
    - not config_file.stat.exists

- name: Set facts
  set_fact:
    app_name: "{{ app_dir |Â basename }}"
    app_namespace: "{% if config_file.stat.exists %}{{ app.namespace }}{% else %}{{ namespace }}{% endif %}"
