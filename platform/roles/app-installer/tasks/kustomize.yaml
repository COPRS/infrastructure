- name: Generate helm template
  import_tasks: template_helm_chart.yaml

- name: Create tmp directory for kustomize
  tempfile:
    state: directory
    suffix: kustomize
  register: kustomize_dir

- name: Copy app files to remote host
  copy:
    src: "{{ app_dir }}/"
    dest: "{{ kustomize_dir.path }}"

## https://github.com/kubernetes-sigs/kustomize/issues/876
- name: deploy app
  shell: "{{ bin_dir }}/kustomize build {{ kustomize_dir.path }}/{{ env }} | {{ bin_dir }}/kubectl apply -f - --prune -n {{ app.namespace }} -l app.kubernetes.io/instance={{ app_name }},app.kubernetes.io/managed-by=Kustomize"
  register: kubectl_apply

- name: display deployed resources
  debug:
    msg: "{{ kubectl_apply.stdout_lines }}"
