kind: DaemonSet

image:
  repository: fluent/fluent-bit
  tag: 1.8.10

logLevel: warn

serviceMonitor:
  enabled: true
  interval: 2m

resources:
  limits:
    cpu: 100m
    memory: 100Mi
  requests:
    cpu: 50m
    memory: 50Mi

luaScripts:
 scripts.lua: |
    function auditdLogfileNameParse(tag, timestamp, record)
        intermediate=string.gsub(tag, '.log', '')
        hostname=string.gsub(intermediate, 'security.auditd.var.audit.audit_', '')
        record["host_name"]=hostname
        return 1, timestamp, record
    end

## https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/configuration-file
config:
  service: |
    [SERVICE]
      Daemon Off
      Flush 1
      Log_Level warn
      Parsers_File parsers.conf
      Parsers_File custom_parsers.conf
      HTTP_Server On
      HTTP_Listen 0.0.0.0
      HTTP_Port 2020
      Health_Check On
  ## https://docs.fluentbit.io/manual/pipeline/inputs
  inputs: |
    [INPUT]
      Name             tail
      Multiline.parser cri
      Tag              processing.log.*
      Path             /var/log/containers/*.log
      Exclude_Path     /var/log/containers/*fluent*.log,/var/log/containers/keycloak-?_iam_keycloak-*.log,/var/log/containers/apisix-*_networking_apisix-*.log,/var/log/containers/falco-?????_security_falco*.log,/var/log/containers/nmap-job-*.log
      DB               /var/log/fluentbit/processing_log.db
      DB.Sync          Normal
      Rotate_Wait      10
      Buffer_Max_Size  1MB
      Mem_Buf_Limit    20MB
    [INPUT]
      Name             systemd
      Tag              system.*
      Max_Entries      500
      Read_From_Tail   On
      DB               /var/log/fluentbit/systemd.db
      DB.Sync          Normal
      Strip_Underscores On
    [INPUT]
      Name             tail
      Tag              security.keycloak.*
      Path             /var/log/containers/keycloak-?_iam_keycloak-*.log
      DB               /var/log/fluentbit/keycloak.db
      DB.Sync          Normal
      Rotate_Wait      10
      Buffer_Max_Size  1MB
      Mem_Buf_Limit    10MB
    [INPUT]
      Name             tail
      Tag              security.ingress.*
      Path             /var/log/containers/apisix-*_networking_apisix-*.log
      DB               /var/log/fluentbit/apisix.db
      DB.Sync          Normal
      Rotate_Wait      10
      Buffer_Max_Size  1MB
      Mem_Buf_Limit    10MB
    [INPUT]
      Name             tail
      Tag              security.wazuh.*
      Path             /var/ossec/logs/alerts/alerts.json
      DB               /var/log/fluentbit/security_wazuh.db
      DB.Sync          Normal
      Rotate_Wait      10
      Buffer_Max_Size  1MB
      Mem_Buf_Limit    10MB
    [INPUT]
      Name             tail
      Tag              security.auditd.*
      Path             /var/log/audit_*.json
      DB               /var/log/fluentbit/security_auditd.db
      DB.Sync          Normal
      Rotate_Wait      10
      Buffer_Max_Size  1MB
      Mem_Buf_Limit    10MB
    [INPUT]
      Name             tail
      Tag              security.falco.*
      Path             /var/log/containers/falco-?????_security_falco*.log
      DB               /var/log/fluentbit/security_falco.db
      DB.Sync          Normal
      Rotate_Wait      10
      Buffer_Max_Size  1MB
      Mem_Buf_Limit    10MB
    [INPUT]
      Name             tail
      Tag              security.scans.*
      Path             /var/log/containers/nmap-job-*.log
      DB               /var/log/fluentbit/security_nmap.db
      DB.Sync          Normal
      Rotate_Wait      10
      Buffer_Max_Size  1MB
      Mem_Buf_Limit    10MB
  ## https://docs.fluentbit.io/manual/pipeline/filters
  filters: |
    # Rename CRI parser 'message' to 'log'
    [FILTER]
      Name    modify
      Match   processing.*
      Rename  message log
    # Keep only logins related logs from keycloak
    [FILTER]
      Name    grep
      Match   security.keycloak.*
      Regex   log /.*type=LOGIN|LOGIN_ERROR.*/
    # Do not send clamd logs with the rest of systemd logs
    [FILTER]
      Name    grep
      Match   system.*
      Exclude SYSLOG_IDENTIFIER clamd
    [FILTER]
      Name    grep
      Match   security.ingress.*
      Regex   log /.*stdout.*/
    [FILTER]
      Name    lua
      Match   security.auditd.*
      Script  /fluent-bit/scripts/scripts.lua
      Call    auditdLogfileNameParse
    # Find and duplicate TRACE logs
    [FILTER]
      Name    rewrite_tag
      Match   processing.log.*
      Rule log .*"type":"REPORT".* processing.trace.* true
    # Retrieve additional kubernetes information
    [FILTER]
      Name                kubernetes
      Match               processing.log.*
      Kube_Tag_Prefix     processing.log.var.log.containers.
      Kube_URL            https://kubernetes.default.svc:443
      Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
      Labels              Off
      Annotations         Off
      Merge_Log           Off
      K8S-Logging.Parser  On
      K8S-Logging.Exclude On
      Keep_Log            Off
      Buffer_Size         1MB 
  ## https://docs.fluentbit.io/manual/pipeline/outputs
  outputs: |
    [OUTPUT]
      Name loki
      Match processing.log.*
      Labels fluentbit=log
      Label_Keys $kubernetes['pod_name'],$kubernetes['namespace_name'],$kubernetes['host'],$kubernetes['container_name'],$kubernetes['container_image']
      Host loki-loki-distributed-distributor.logging.svc.cluster.local
      Port 3100
    [OUTPUT]
      Name loki
      Match system.*
      Labels fluentbit=system
      Label_Keys $SYSLOG_IDENTIFIER,$HOSTNAME
      Host loki-loki-distributed-distributor.logging.svc.cluster.local
      Port 3100
    [OUTPUT]
      Name        kafka
      Format      json
      Match       processing.trace.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.trace
      rdkafka.enable.idempotence true
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.wazuh.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.wazuh
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.auditd.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.auditd
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.falco.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.falco
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.scans.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.scans
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.ingress.*
      Brokers     kafka-cluster-kafka-brokers.infra.svc.cluster.local:9092
      Topics      fluentbit.ingress
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.keycloak.*
      Brokers     kafka-cluster-kafka-brokers.infra.svc.cluster.local:9092
      Topics      fluentbit.keycloak
      Buffer_Size 64KB
  ## https://docs.fluentbit.io/manual/pipeline/parsers
  customParsers: ""
 
daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers
  - name: etcmachineid
    hostPath:
      path: /etc/machine-id
      type: File
  - name: wazuh-alert
    hostPath:
      path: /var/ossec/logs/alerts

daemonSetVolumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true
  - name: etcmachineid
    mountPath: /etc/machine-id
    readOnly: true
  - name: wazuh-alert
    mountPath: /var/ossec/logs/alerts
    readOnly: true

tolerations:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
  - effect: NoSchedule
    key: node-role.kubernetes.io/gateway
