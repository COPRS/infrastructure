kind: DaemonSet

image:
  repository: fluent/fluent-bit
  tag: 1.8.10

logLevel: warn

serviceMonitor:
  enabled: true
  interval: 2m

resources:
  limits:
    cpu: 100m
    memory: 512Mi
  requests:
    cpu: 20m
    memory: 128Mi

luaScripts:
 scripts.lua: |
    function is_record(tag, timestamp, record)
      if record ~= nil and record["log"] ~= nil then
        if string.match(record["log"], "\"type\":\"REPORT\"") then
          return 0, timestamp, record
        end
      end
      return -1, 0, 0
    end

    function auditdLogfileNameParse(tag, timestamp, record)
        intermediate=string.gsub(tag, '.log', '')
        hostname=string.gsub(intermediate, 'security.auditd.var.audit.audit_', '')
        record["host_name"]=hostname
        return 1, timestamp, record
    end

## https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/configuration-file
config:
{% raw %}
  service: |
    [SERVICE]
      Daemon Off
      Flush 1
      Log_Level {{ .Values.logLevel }}
      Parsers_File parsers.conf
      Parsers_File custom_parsers.conf
      HTTP_Server On
      HTTP_Listen 0.0.0.0
      HTTP_Port {{ .Values.service.port }}
      Health_Check On
{% endraw %}
  ## https://docs.fluentbit.io/manual/pipeline/inputs
  inputs: |
    [INPUT]
      Name             tail
      parser           cri
      Tag              processing.log.*
      Path             /var/log/containers/*.log
      Exclude_Path     /var/log/containers/*fluent*.log,/var/log/containers/keycloak-?_iam_keycloak-*.log,/var/log/containers/apisix-*_networking_apisix-*.log,/var/log/containers/falco-?????_security_falco*.log,/var/log/containers/nmap-job-*.log
      DB               /var/log/fluentbit_processing.db
      DB.Sync          Normal
      Rotate_Wait      10
      buffer_max_size  10MB
    [INPUT]
      Name             tail
      parser           cri
      Tag              processing.trace.*
      Path             /var/log/containers/*.log
      Exclude_Path     /var/log/containers/*fluent*.log,/var/log/containers/keycloak-?_iam_keycloak-*.log,/var/log/containers/apisix-*_networking_apisix-*.log,/var/log/containers/falco-?????_security_falco*.log,/var/log/containers/nmap-job-*.log
      DB               /var/log/fluentbit_trace.db
      DB.Sync          full
      Rotate_Wait      10
    [INPUT]
      Name             tail
      Tag              system.*
      Path             /var/log/syslog
      DB               /var/log/fluentbit_system.db
      DB.Sync          Normal
      Rotate_Wait      10
      buffer_max_size  10MB
    [INPUT]
      Name             tail
      Tag              security.keycloak.*
      Path             /var/log/containers/keycloak-?_iam_keycloak-*.log
      DB               /var/log/keycloak.db
      DB.Sync          Normal
      Rotate_Wait      10
      buffer_max_size  10MB
    [INPUT]
      Name             tail
      Tag              security.ingress.*
      Path             /var/log/containers/apisix-*_networking_apisix-*.log
      DB               /var/log/fluentbit_apisix.db
      DB.Sync          Normal
      Rotate_Wait      10
      buffer_max_size  10MB
    [INPUT]
      Name             tail
      Tag              security.wazuh.*
      Path             /var/ossec/logs/alerts/alerts.json
      DB               /var/log/fluentbit-security_wazuh.db
      DB.Sync          Normal
      Rotate_Wait      10
      buffer_max_size  10MB
    [INPUT]
      Name             tail
      Tag              security.auditd.*
      Path             /var/log/audit_*.json
      DB               /var/log/fluentbit-security_auditd.db
      DB.Sync          Normal
      Rotate_Wait      10
      buffer_max_size  10MB
    [INPUT]
      Name             tail
      Tag              security.falco.*
      Path             /var/log/containers/falco-?????_security_falco*.log
      DB               /var/log/fluentbit-security_falco.db
      DB.Sync          Normal
      Rotate_Wait      10
      buffer_max_size  10MB
    [INPUT]
      Name             tail
      Tag              security.scans.*
      Path             /var/log/containers/nmap-job-*.log
      DB               /var/log/fluentbit-security_nmap.db
      DB.Sync          Normal
      Rotate_Wait      10
      Mem_Buf_Limit    10MB
  ## https://docs.fluentbit.io/manual/pipeline/filters
  filters: |
    [FILTER]
      Name    modify
      Match   processing.*
      Rename  message log
    [FILTER]
      Name    grep
      Match   processing.log.*
      Exclude log /.*ignoring file with negative size file: .*: -1/
    [FILTER]
      Name    grep
      Match   processing.log.*
      Exclude $log['header']['file'] ProductDistributionController.java
    [FILTER]
      Name    grep
      Match   security.keycloak.*
      Regex   log /.*type=LOGIN|LOGIN_ERROR.*/
    [FILTER]
      Name    grep
      Match   security.ingress.*
      Regex   log /.*stdout.*/
    [FILTER]
      Name    lua
      Match   processing.trace.*
      Script  /fluent-bit/scripts/scripts.lua
      Call    is_record
    [FILTER]
      Name    lua
      Match   security.auditd.*
      Script  /fluent-bit/scripts/scripts.lua
      Call    auditdLogfileNameParse
    [FILTER]
      Name                kubernetes
      Match               processing.log.*
      Kube_Tag_Prefix     processing.log.var.log.containers.
      Kube_URL            https://kubernetes.default.svc:443
      Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
      Merge_Log           On
      K8S-Logging.Parser  On
      K8S-Logging.Exclude On
      Keep_Log            Off
    [FILTER]
      Name                kubernetes
      Match               processing.trace.*
      Kube_Tag_Prefix     processing.trace.var.log.containers.
      Kube_URL            https://kubernetes.default.svc:443
      Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
      Merge_Log           Off
      K8S-Logging.Parser  On
      K8S-Logging.Exclude On
      Keep_Log            Off

  ## https://docs.fluentbit.io/manual/pipeline/outputs
  outputs: |
    [OUTPUT]
      Name        kafka
      Format      json
      Match       processing.log.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.processing
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       processing.trace.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.trace
      rdkafka.enable.idempotence true
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       system.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.system
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.wazuh.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.wazuh
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.auditd.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.auditd
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.falco.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.falco
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.scans.*
      Brokers     kafka-cluster-kafka-bootstrap.infra.svc.cluster.local:9092
      Topics      fluentbit.scans
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.ingress.*
      Brokers     kafka-cluster-kafka-brokers.infra.svc.cluster.local:9092
      Topics      fluentbit.ingress
      Buffer_Size 64KB
    [OUTPUT]
      Name        kafka
      Format      json
      Match       security.keycloak.*
      Brokers     kafka-cluster-kafka-brokers.infra.svc.cluster.local:9092
      Topics      fluentbit.keycloak
      Buffer_Size 64KB
  ## https://docs.fluentbit.io/manual/pipeline/parsers
  customParsers: |
    [PARSER]
      Name        cri
      Format      regex
      Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
      Time_Key    time
      Time_Format %Y-%m-%dT%H:%M:%S.%L%z
      Time_Keep   On
 
daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers
  - name: etcmachineid
    hostPath:
      path: /etc/machine-id
      type: File
  - name: wazuh-alert
    hostPath:
      path: /var/ossec/logs/alerts

daemonSetVolumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true
  - name: etcmachineid
    mountPath: /etc/machine-id
    readOnly: true
  - name: wazuh-alert
    mountPath: /var/ossec/logs/alerts
    readOnly: true

tolerations:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
  - effect: NoSchedule
    key: node-role.kubernetes.io/gateway
