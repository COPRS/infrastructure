- name: Get host list with safescale
  shell: "{{ safescale_path }} cluster inspect {{ cluster.name }}"
  register: cluster_inspect

- name: Parse inspect result
  set_fact:
    sf_cluster: "{{ cluster_inspect.stdout | from_json }}"

- name: Read primary gateway IP
  set_fact:
    gateway:
      - name: gw-{{ cluster.name }}
        private_ip: "{{ sf_cluster.result.primary_gateway_ip }}"
        id: "{{ lookup('pipe', safescale_path + ' host inspect ' + 'gw-' + cluster.name + '| jq -r .result.id') }}"

- name: Read secondary gateway IP
  set_fact:
    gateway2: 
      - name: gw2-{{ cluster.name }}
        private_ip: "{{ sf_cluster.result.secondary_gateway_ip }}"
        id: "{{ lookup('pipe', safescale_path + ' host inspect ' + 'gw2-' + cluster.name + '| jq -r .result.id') }}"
  when: sf_cluster.result.secondary_gateway_ip is defined

- name: Create complete hosts list
  set_fact:
    hosts: "{{ sf_cluster.result.nodes.nodes }} + {{ sf_cluster.result.nodes.masters }} + {{ gateway }} {%- if gateway2 is defined %} + {{ gateway2 }}{%- endif %}"

- name: Getting the node groups from safescale tags
  shell: "{{ safescale_path }} tag list | jq -c .result"
  register: tag_list

- name: Parse safescale tags to nodegroups
  set_fact:
    nodegroups: "{{ tag_list.stdout | from_json }}"
